import{x as Q,r as v,e as Z,I as ee,c as r,a as s,i as a,t as F,d as oe,m as f,z as w,F as te,g as ne,O as le,o as i,M as re,p as S,A as se,f as ie}from"#entry";import{h as Y}from"./BLMuvzoS.js";const ue={class:"relative w-full h-screen bg-gray-100 p-4 select-none overflow-x-hidden"},ae={class:"flex gap-2 mb-4 items-center"},de=["disabled"],ce={class:"ml-4 flex items-center gap-2"},pe=["onMousedown"],me=["onMousedown"],_e=["onUpdate:modelValue","onChange"],ve=["onUpdate:modelValue"],fe=["onChange"],ge=["onUpdate:modelValue","onFocus"],he=["onInput"],xe=["onClick"],we={class:"w-full h-full p-2 overflow-hidden"},ye=["onUpdate:modelValue"],ke=["src"],be=["src"],Ce=["src"],Se=["onMousedown"],Me={key:0,class:"fixed bottom-4 right-4 bg-gray-800 text-white px-4 py-2 rounded shadow flex items-center gap-4 z-50"},Ee={__name:"index",setup(Ie){le();const O=Q(),y=v(O.mainDevServer),m=v(!1),c=v("page1"),l=v([]),_=v([]);let M=10;const u=v({visible:!1,message:"",undoCallback:null,timeoutId:null});function I(n,e=null,o=4e3){u.value.timeoutId&&clearTimeout(u.value.timeoutId),u.value.message=n,u.value.undoCallback=e,u.value.visible=!0,u.value.timeoutId=setTimeout(()=>{u.value.visible=!1,u.value.undoCallback=null},o)}Z(()=>U());async function U(){try{const n=await fetch(`${y.value}/api/cms/boxes/`);if(!n.ok){l.value=[];return}const e=await n.json(),o=Array.isArray(e?.boxes)?e.boxes:[];l.value=o.map(t=>({file_url:Array.isArray(t.file_url)?t.file_url:t.file_url?[{url:t.file_url}]:[],component_properties:t.component_properties||{},zIndex:++M,cms_id:t.cms_id||"CMS"+Y().valueOf(),component_width:Number(t.component_width)||240,component_height:Number(t.component_height)||180,component_top:Number(t.component_top)||100,component_left:Number(t.component_left)||100,component_type:t.component_type||"text",component_content:t.component_content||"",page_route_link_belong:t.page_route_link_belong||c.value}))}catch(n){console.error("loadBoxes error:",n),l.value=[]}}const P=ee(()=>l.value.filter(n=>n.page_route_link_belong===c.value));function k(n){(!Array.isArray(n.file_url)||!n.file_url.length)&&(n.file_url=[{url:""}])}function X(){const n={cms_id:"CMS"+Y().valueOf(),component_width:200,component_height:200,component_top:100,component_left:100,component_type:"text",component_content:"",component_properties:{},file_url:[],page_route_link_belong:c.value};l.value.push(n)}function j(n){m.value&&(n.zIndex=++M)}function b(n){return l.value.findIndex(e=>e.cms_id===n)}async function R(n,e){const o=n.target.files[0];if(!o)return;const t=new FormData;t.append("file",o);try{const p=await(await fetch(`${y.value}/api/cms/upload-file/`,{method:"POST",body:t})).json(),x=b(e);if(x===-1)return;k(l.value[x]),l.value[x].file_url[0].url=p.storage_url||p.url||"",l.value[x].file_url[0].name=p.name||o.name}catch(d){console.error("upload error",d)}}function H(n,e){const o=n.target.value,t=b(e);if(t!==-1)try{const d=new URL(o);let p="";d.hostname.includes("youtube.com")?p=d.searchParams.get("v"):d.hostname.includes("youtu.be")&&(p=d.pathname.substring(1)),p&&(l.value[t].component_properties.videoEmbed=`https://www.youtube.com/embed/${p}`)}catch(d){console.warn("invalid video url",d)}}async function J(){const n=l.value.map(e=>({cms_id:e.cms_id,component_width:String(e.component_width||""),component_height:String(e.component_height||""),component_top:String(e.component_top||""),component_left:String(e.component_left||""),component_type:e.component_type||"text",component_content:e.component_content||"",component_properties:e.component_properties||{},file_url:Array.isArray(e.file_url)?e.file_url:e.file_url?[{url:e.file_url}]:[],page_route_link_belong:e.page_route_link_belong||c.value}));try{const e=await fetch(`${y.value}/api/cms/boxes/save/`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!e.ok){const t=await e.text();console.error("save error",e.status,t),alert("Save failed. See console.");return}const o=await e.json();alert(o.message||"Saved!"),await U()}catch(e){console.error("saveBoxes error",e),alert("Save failed â€” check console.")}}function W(n){const e=b(n);e!==-1&&(_.value.push(l.value[e]),l.value.splice(e,1),I("1 box deleted",C))}function q(){const n=l.value.filter(e=>e.page_route_link_belong===c.value);n.length&&(_.value.push(...n),l.value=l.value.filter(e=>e.page_route_link_belong!==c.value),I(`${n.length} boxes deleted`,C))}function C(){_.value.length&&(l.value.push(..._.value),_.value=[],u.value.visible=!1)}let g=null,B=0,E=0;function G(n,e){g=e;const o=l.value.find(t=>t.cms_id===e);B=n.clientX-(Number(o.component_left)||0),E=n.clientY-(Number(o.component_top)||0),window.addEventListener("mousemove",V),window.addEventListener("mouseup",z)}function V(n){if(!g)return;const e=l.value.find(o=>o.cms_id===g);e.component_left=n.clientX-B,e.component_top=n.clientY-E}function z(){g=null,window.removeEventListener("mousemove",V),window.removeEventListener("mouseup",z)}let h=null,L=0,N=0,A=0,D=0;function K(n,e){h=e;const o=l.value.find(t=>t.cms_id===e);L=Number(o.component_width)||0,N=Number(o.component_height)||0,A=n.clientX,D=n.clientY,window.addEventListener("mousemove",$),window.addEventListener("mouseup",T)}function $(n){if(!h)return;const e=l.value.find(o=>o.cms_id===h);e.component_width=Math.max(40,L+(n.clientX-A)),e.component_height=Math.max(40,N+(n.clientY-D))}function T(){h=null,window.removeEventListener("mousemove",$),window.removeEventListener("mouseup",T)}return(n,e)=>(i(),r("div",ue,[s("div",ae,[s("button",{class:"px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700",onClick:X}," Add Box "),s("button",{class:"px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700",onClick:e[0]||(e[0]=o=>m.value=!m.value)},F(m.value?"Disable Edit Mode":"Enable Edit Mode"),1),s("button",{class:"px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700",onClick:J}," Save Boxes "),s("button",{class:"px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700",onClick:q}," Delete All Boxes "),s("button",{class:"px-4 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-600",disabled:_.value.length===0,onClick:C}," Undo Delete ",8,de),s("div",ce,[e[5]||(e[5]=oe(" Current Page: ",-1)),f(s("input",{type:"text","onUpdate:modelValue":e[1]||(e[1]=o=>c.value=o),class:"border rounded px-1 w-32"},null,512),[[w,c.value]])])]),(i(!0),r(te,null,ne(P.value,o=>(i(),r("div",{key:o.cms_id,class:"absolute border border-purple-600 rounded-md shadow-md bg-white",style:re({width:(o.component_width||240)+"px",height:(o.component_height||180)+"px",top:(o.component_top||100)+"px",left:(o.component_left||100)+"px",zIndex:o.zIndex||1}),onMousedown:t=>j(o),onClick:e[3]||(e[3]=t=>!m.value)},[m.value?(i(),r("div",{key:0,class:"absolute -top-14 left-0 w-full bg-white shadow-md rounded p-2 flex gap-2 items-center z-50",onMousedown:e[2]||(e[2]=S(()=>{},["stop"]))},[s("div",{class:"px-2 py-1 bg-purple-600 text-white text-xs cursor-move rounded",onMousedown:S(t=>G(t,o.cms_id),["stop"])}," Drag ",40,me),f(s("select",{"onUpdate:modelValue":t=>o.component_type=t,class:"border rounded px-1 text-sm",onChange:t=>k(o)},[...e[6]||(e[6]=[ie('<option value="text">Text</option><option value="image">Image</option><option value="image_link">Image Link</option><option value="video">Video</option><option value="file">File</option>',5)])],40,_e),[[se,o.component_type]]),f(s("input",{type:"text","onUpdate:modelValue":t=>o.page_route_link_belong=t,class:"border rounded px-1 text-sm w-32",placeholder:"page1"},null,8,ve),[[w,o.page_route_link_belong]]),o.component_type==="image"||o.component_type==="file"?(i(),r("input",{key:0,type:"file",onChange:t=>R(t,o.cms_id)},null,40,fe)):a("",!0),o.component_type==="image_link"?f((i(),r("input",{key:1,type:"url","onUpdate:modelValue":t=>o.file_url[0].url=t,class:"border rounded px-1 w-40",placeholder:"Image URL",onFocus:t=>k(o)},null,40,ge)),[[w,o.file_url[0].url]]):a("",!0),o.component_type==="video"?(i(),r("input",{key:2,type:"url",onInput:t=>H(t,o.cms_id),class:"border rounded px-1 w-40",placeholder:"YouTube URL"},null,40,he)):a("",!0),s("button",{class:"px-2 py-1 bg-red-600 text-white text-xs rounded hover:bg-red-700",onClick:t=>W(o.cms_id)}," Delete ",8,xe)],32)):a("",!0),s("div",we,[o.component_type==="text"?f((i(),r("textarea",{key:0,"onUpdate:modelValue":t=>o.component_content=t,class:"w-full h-full whitespace-pre-wrap"},null,8,ye)),[[w,o.component_content]]):a("",!0),["image","image_link"].includes(o.component_type)&&o.file_url.length&&o.file_url[0].url?(i(),r("img",{key:1,src:o.file_url[0].url,class:"w-full h-full object-contain"},null,8,ke)):a("",!0),o.component_type==="video"&&o.component_properties.videoEmbed?(i(),r("iframe",{key:2,src:o.component_properties.videoEmbed,class:"w-full h-64",frameborder:"0",allowfullscreen:""},null,8,be)):a("",!0),o.component_type==="file"&&o.file_url.length&&o.file_url[0].url?(i(),r("iframe",{key:3,src:o.file_url[0].url,class:"w-full h-full"},null,8,Ce)):a("",!0)]),m.value?(i(),r("div",{key:1,class:"absolute bottom-0 right-0 w-4 h-4 bg-purple-600 cursor-se-resize rounded-br",onMousedown:S(t=>K(t,o.cms_id),["stop"])},null,40,Se)):a("",!0)],44,pe))),128)),u.value.visible?(i(),r("div",Me,[s("span",null,F(u.value.message),1),u.value.undoCallback?(i(),r("button",{key:0,onClick:e[4]||(e[4]=o=>u.value.undoCallback()),class:"bg-yellow-500 px-2 py-1 rounded hover:bg-yellow-600 text-xs"}," Undo ")):a("",!0)])):a("",!0)]))}};export{Ee as default};
